# 构建大型网站：分布式改造

## 为什么要做分布式化

所谓分布式改造就是尽量让系统无状态化，以利于季候的扩展。

实现应用的分布式改造先解决好一下几个问题：

+ 应用需要微服务化
+ 必须先建立分布式服务框架
+ 必须解决状态一致性问题

## 典型的分布式架构

分布式架构VS传统的单机架构的区别在于分布式架构能解决两个方向的扩展问题：

+ 横向扩展：主要用来解决应用架构上的容量问题
+ 纵向扩展：主要解决业务的扩展问题。

1. 需要分布式中间件
2. 服务化和分布式化

## 分布式配置框架

两种管理模式：

1. 拉取模式。客户端主动向服务器询问配置信息是否有更新，如果有则拉取信息更新自己。缺点：服务器没法主动及时推送更新信息。（使用场景：客户端很多）
2. 推送模式：服务器主动把信息推送给每个客户端。缺点：服务器必须感知每个可兑换的状态，管理难度大。（使用场景：对配置下方延时率比较敏感，且客户端不是很多）

![image-20200415221103609](https://gitee.com/hfqy/picture_bed/raw/master/img/20200415221110.png)

必须考虑的问题：

1. 不要让服务器的网卡成为瓶颈，尤其是下发的数据量较大时
2. 要保证配置下发的到达率

## 分布式RPC框架

![image-20200415222051306](https://gitee.com/hfqy/picture_bed/raw/master/img/20200415222057.png)

1. 服务注册
2. 服务发现
3. 服务调度和负载均衡
4. 统一的SDK封装

 ## 分布式消息框架

1. 实时消息
   	1. 异步解耦
    	2. 多消费者

2. 延时消息
3. [常见的消息中间件](http://queus.io)
4. [几种常见的消息中间件对比](https://my.oschina.net/blogByRzc/blog/3012251)

## 分布式数据层

1. 分库分表
2. 主备读写分离

## 分布式文件系统

[分布式文件系统概念](https://www.cnblogs.com/wwchihiro/p/9242542.html)

[各种分布式文件系统比较](https://blog.csdn.net/baiducheng/article/details/78210752)

[文件存储系统基本架构](https://zhuanlan.zhihu.com/p/27666295)

## 应用的服务化改造

1. 应用分层设计
2. 微服务化

[Spring Boot 基础](https://www.ibm.com/developerworks/cn/java/j-spring-boot-basics-perry/index.html)

## 分布式化遇到的典型问题

[ZooKeeper官网](http://zookeeper.apache.org/)

[Zookeeper 教程](https://www.w3cschool.cn/zookeeper/)

1. 集群管理
2. 共享锁
3. 队列管理

## 分布式消息通道服务的设计

## 典型的分布式集群设计思路

+ Master/Slave模式
+ 无对等

# 无线化：无线时代下的架构演进

## 无线环境的新挑战：

+ 客户端的问题
+ 服务端的问题
+ 多端登录和多屏互动的问题

理想的无线接入层：

+ 简单、对业务系统透明
+ 高效稳定

## 端的演进

1. HTML5 or Native

   [两者的区别](https://blog.csdn.net/wangshufen20091651/article/details/71122926)

2. HTML5的页面优化
   1. CSS内联异步加载
   2. 其他的优化
   3. bigpipe首屏加载

3. Cookie压缩
   1. Cookie的全部压缩
   2. Cookie的部分压缩

4. URL短域名
5. CDN前置缓存

6. 如何实现端的快速迭代

## 无线链路的优化

1. 无线端请求合并

2. 数据量大小的影响

   结论：

   + 无线环境下，较少网络请求次数对首屏加载性能有比较明显的影响
   + 无线环境下的文件大小与PC环境下的文件大小对性能的影响效果不同，无线更明显
   + CDN直接Cache可以大幅提升性能
   + 小数据情况下，动态加速和直接回主站没有明显优势

3. CDN动态加速

4. WebP图片优化
   + 红色字体被压缩后普遍偏暗
   + 部分蓝色字体被压缩之后偏模糊
   + 当背景为黑色的时候，红色小字体偏模糊
   + 当背景为红色的时候，黑色小字体偏模糊
   + png图片不能使用Webp
   + gif转Webp非常耗性能，所以只处理第一帧图片
   + 原图转换成WebP非常耗性能，图片的所有缩略图先转JPEG，再转WenP
   + 压缩级别在m0-m2时，不少图片丢失色块（出现马赛克），压缩级别在m3及以上时则较少出现此问题，同时m3级别所节约的带宽和m4级别非常接近，但m3的转化性能明显高于m4。==m3级别似乎最优==。

## 服务端的演进

1. JSON化接口
2. 业务层组件化
3. MC和V的分离演进
1. [Node.js 教程](https://www.runoob.com/nodejs/nodejs-tutorial.html)
2. [Node.js v12.16.2 文档](http://nodejs.cn/api/)

# 大型网站平台化演进：大中台小前台

## 为什么需要中台

111